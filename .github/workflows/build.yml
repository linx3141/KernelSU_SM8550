name: Compile Kernel

on:
  workflow_dispatch:
    inputs:
      clang_version:
        description: Type the clang version of ur kernel
        required: true
        type: choice
        options:
          - clang-3289846
          - clang-r547379
          - clang-r563880
          - clang-r563880c
          - clang-r574158
          - clang-stable
          
      kernel_source:
        description: Kernel Source Code
        required: true
        type: choice
        options:
          - LineageOS
          - crdroidandroid

      module_source:
        description: Kernel Module Source Code
        required: true
        type: choice
        options:
          - LineageOS
          - crdroidandroid
          
      kernel_branch:
        description: Kernel Branch(such as lineage-23.2 sixteen-qpr1)
        required: true
        type: string
        default: ""
        
      ksu_type:
        description: "KernelSU Version"
        required: true
        type: choice
        options:
          - None
          - Official-KernelSU
          - KernelSU-Next
          - KernelSU-Next-with-susfs
          - KowSU
          - ReSukiSU
          - ReSukiSU-with-susfs

      kernel_name:
        description: "Custom Kernel Name"
        required: false
        type: string
        default: ""

      # ── ReKernel ──────────────────────────────────────────────────────────────
      enable_rekernel:
        description: "Integrate Re:Kernel (Netlink tombstone module)"
        required: true
        type: choice
        default: "false"
        options:
          - "false"
          - "true"
      # ─────────────────────────────────────────────────────────────────────────
          
jobs:
  Kernel_CI:
    env:
        GH_TOKEN: ${{ github.token }}
        SOC: sm8650
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      checks: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SWAP
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 16
          
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
          bc bison flex \
          libssl-dev \
          libelf-dev \
          libdw-dev \
          build-essential \
          lz4 \
          git \
          python3 \
          curl \
          dwarves \
          cpio \
          gcc-aarch64-linux-gnu \
          openjdk-17-jdk-headless
          
      - name: Clone Kernel Source
        run: |
          git clone --depth=1 -b ${{ inputs.kernel_branch }} https://github.com/${{ inputs.kernel_source }}/android_kernel_oneplus_${SOC}.git ${SOC}
          git clone --depth=1 -b ${{ inputs.kernel_branch }} https://github.com/${{ inputs.module_source }}/android_kernel_oneplus_${SOC}-modules.git ${SOC}-modules

      - name: Download AOSP Clang
        run: |
          mkdir -p toolchains/${{ inputs.clang_version }}
          cd toolchains

          curl -LO https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android16-qpr2-release/${{ inputs.clang_version }}.tar.gz
          tar -xf "${{ inputs.clang_version }}.tar.gz" -C ${{ inputs.clang_version }}

      # ── ReKernel Integration ──────────────────────────────────────────────────
      - name: Integrate Re:Kernel
        if: ${{ inputs.enable_rekernel == 'true' }}
        run: |
          echo ">>> Downloading Re:Kernel Kernel Modifier..."
          # 从 Re:Kernel 最新 Release 拉取 Modifier jar
          MODIFIER_URL=$(curl -s https://api.github.com/repos/Sakion-Team/Re-Kernel/releases \
            | python3 -c "
          import sys, json
          releases = json.load(sys.stdin)
          for r in releases:
              for a in r.get('assets', []):
                  if a['name'].endswith('.jar'):
                      print(a['browser_download_url'])
                      sys.exit(0)
          ")
          if [ -z "${MODIFIER_URL}" ]; then
            echo "ERROR: Could not find Kernel Modifier jar in Re:Kernel releases!"
            exit 1
          fi
          echo "Modifier URL: ${MODIFIER_URL}"
          curl -L -o KernelModifier.jar "${MODIFIER_URL}"

          echo ">>> Running Re:Kernel Kernel Modifier on kernel source..."
          # Modifier 要求在内核源码根目录下运行
          cp KernelModifier.jar ${SOC}/
          cd ${SOC}
          # || true: Modifier exits non-zero on partial failures, but we handle them below
          java -jar KernelModifier.jar || true

          # ── Post-modifier patch: fix two known Modifier v4.0 bugs ──────────────
          # Bug 1 (line ~439): Modifier inserted a duplicate 'static' keyword,
          #   causing [-Werror,-Wduplicate-decl-specifier].
          #   Fix: collapse any "static static" back to a single "static".
          # Bug 2 (line ~490): Modifier declared 'proc_task' but couldn't complete
          #   the insertion (see "Failed to insert binder buffer" above), leaving
          #   an unused variable that triggers [-Werror,-Wunused-variable].
          #   Fix: remove the orphaned declaration so the file compiles cleanly.
          BINDER_FILE="drivers/android/binder_alloc.c"
          if [ -f "${BINDER_FILE}" ]; then
            echo ">>> Applying post-modifier fixes to ${BINDER_FILE}..."

            # Fix Bug 1: "static static" → "static"
            sed -i 's/\bstatic[[:space:]]\+static\b/static/g' "${BINDER_FILE}"

            # Fix Bug 2: remove orphaned 'proc_task' declaration
            # (safe to remove because the surrounding usage code was never inserted)
            sed -i '/struct task_struct \*proc_task[[:space:]]*=.*binder_get_task/d' "${BINDER_FILE}"

            echo ">>> Post-modifier fixes applied."
          fi
          # ───────────────────────────────────────────────────────────────────────

          echo ">>> Re:Kernel integration complete."
      # ─────────────────────────────────────────────────────────────────────────

      - name: Compile Kernel
        run: |
          CLANG_ROOT="${GITHUB_WORKSPACE}/toolchains/${{ inputs.clang_version }}/bin"
          export PATH="${CLANG_ROOT}:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CC="${CLANG_ROOT}/clang"
          export CXX="${CLANG_ROOT}/clang++"
          export HOSTCC="${CLANG_ROOT}/clang"
          export HOSTCXX="${CLANG_ROOT}/clang++"
          export LD="${CLANG_ROOT}/ld.lld"
          export AR="${CLANG_ROOT}/llvm-ar"
          export NM="${CLANG_ROOT}/llvm-nm"
          export OBJCOPY="${CLANG_ROOT}/llvm-objcopy"
          export OBJDUMP="${CLANG_ROOT}/llvm-objdump"
          export STRIP="${CLANG_ROOT}/llvm-strip"

          cd ${SOC}

          case "${{ inputs.ksu_type }}" in
          
            "None")
              ;;
              
            "Official-KernelSU")
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
              ;;
              
            "KowSU")
               curl -LSs "https://raw.githubusercontent.com/KOWX712/KernelSU/main/kernel/setup.sh" | bash -s master
              ;;

            "KernelSU-Next")
              curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s dev
              ;;

            "KernelSU-Next-with-susfs")
              curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/refs/heads/dev-susfs/kernel/setup.sh" | bash -s dev-susfs
              ;;

            "ReSukiSU"|"ReSukiSU-with-susfs")
              curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash -s builtin
              ;;
          esac
          
          if [[ "${{ inputs.ksu_type }}" == *susfs ]]; then
            git clone -b gki-android14-6.1 https://gitlab.com/simonpunk/susfs4ksu.git susfs
            cd susfs
            cp ./kernel_patches/50_add_susfs_in_gki-android14-6.1.patch ..
            cp ./kernel_patches/fs/* ../fs/
            cp ./kernel_patches/include/linux/* ../include/linux/
            cd ..
            patch -p1 < 50_add_susfs_in_gki-android14-6.1.patch
            echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=n" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> arch/arm64/configs/gki_defconfig
          fi
          
          touch ./.scmversion
          sed -i "s|CONFIG_MODULE_SIG_PROTECT=y|CONFIG_MODULE_SIG_PROTECT=n|" arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_XATTR=y" >> arch/arm64/configs/gki_defconfig

          # Apply custom kernel name if provided
          if [[ -n "${{ inputs.kernel_name }}" ]]; then
            CUSTOM_NAME="${{ inputs.kernel_name }}"
            if [[ "${CUSTOM_NAME}" != -* ]]; then
              CUSTOM_NAME="-${CUSTOM_NAME}"
            fi
            echo "CONFIG_LOCALVERSION=\"${CUSTOM_NAME}\"" >> arch/arm64/configs/gki_defconfig
            echo "Kernel name set to: ${CUSTOM_NAME}"
          fi

          make O=out gki_defconfig vendor/pineapple_GKI.config vendor/oplus/pineapple_GKI.config
          make -j2 O=out Image

      - name: Make AnyKernel3
        run: |
          # 若启用 ReKernel，将编译好的 re-kernel.ko 一同打包进刷机包
          ZIP_NAME="${{ inputs.ksu_type }}_$(date -u +"%Y%m%d_%H%M")"
          if [[ "${{ inputs.enable_rekernel }}" == "true" ]]; then
            ZIP_NAME="ReKernel_${ZIP_NAME}"
          fi
          git clone https://github.com/Kernel-SU/AnyKernel3.git

          cp ${SOC}/out/arch/arm64/boot/Image AnyKernel3/Image
          cp ${SOC}/out/arch/arm64/boot/Image ./Image

          # 把所有编译出的 .ko 复制到刷机包（含 re-kernel.ko）
          if [[ "${{ inputs.enable_rekernel }}" == "true" ]]; then
            KO_FILES=$(find ${SOC}/out -name "*.ko" 2>/dev/null)
            if [ -n "${KO_FILES}" ]; then
              mkdir -p AnyKernel3/modules/system/lib/modules
              echo "${KO_FILES}" | xargs -I{} cp {} AnyKernel3/modules/system/lib/modules/
              echo "Packaged kernel modules:"
              ls AnyKernel3/modules/system/lib/modules/
            else
              echo "WARNING: No .ko files found; Re:Kernel may have been integrated inline."
            fi
          fi

          cd AnyKernel3
          zip -r9 ../"${ZIP_NAME}.zip" * -x .git

      - name: Create GitHub Release
        run: |
          REL_NAME="${SOC}_${{ inputs.kernel_source }}-${{ inputs.kernel_branch }}_${{ inputs.ksu_type }}_$(date -u +"%Y%m%d_%H%M")"
          cd ${GITHUB_WORKSPACE}
          ZIP_FILE=$(ls *.zip)
          gh release create "$REL_NAME" --title "$REL_NAME" --notes "" "${ZIP_FILE}" Image
